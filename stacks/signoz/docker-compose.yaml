services:
  # ClickHouse - SigNoz's storage backend
  clickhouse:
    image: clickhouse/clickhouse-server:24.1.2-alpine
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks:
      - observability
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:8123/ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # SigNoz Query Service
  query-service:
    image: signoz/query-service:0.45.1
    command:
      - "-config=/root/config/prometheus.yml"
    volumes:
      - ../../config/signoz/prometheus.yml:/root/config/prometheus.yml:ro
    environment:
      ClickHouseUrl: tcp://clickhouse:9000
      STORAGE: clickhouse
      GODEBUG: netdns=go
      TELEMETRY_ENABLED: "false"
      SIGNOZ_LOCAL_DB_PATH: /var/lib/signoz/signoz.db
    volumes:
      - signoz-data:/var/lib/signoz
    networks:
      - observability
    depends_on:
      clickhouse:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # SigNoz Frontend
  frontend:
    image: signoz/frontend:0.45.1
    environment:
      FRONTEND_API_ENDPOINT: http://query-service:8080
    ports:
      - "3301:3301"
    networks:
      - observability
    depends_on:
      - query-service
    restart: unless-stopped

  # SigNoz OTel Collector
  otel-collector:
    image: signoz/signoz-otel-collector:0.102.12
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ../../config/signoz/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    environment:
      OTEL_RESOURCE_ATTRIBUTES: host.name=signoz-host
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    networks:
      - observability
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: unless-stopped

  # SigNoz Alert Manager
  alertmanager:
    image: signoz/alertmanager:0.23.5
    volumes:
      - ../../config/signoz/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    networks:
      - observability
    restart: unless-stopped

networks:
  observability:
    driver: bridge

volumes:
  clickhouse-data:
  signoz-data:

