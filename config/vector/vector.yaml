# Data directory for Vector state
data_dir: /var/lib/vector

# Docker logs source - only collect from containers with vector.logs.enable=true
sources:
  docker_logs:
    type: docker_logs
    docker_host: unix:///var/run/docker.sock

    # Only collect logs from containers with this label
    include_labels:
      - "vector.logs.enable=true"

    # Auto-merge split messages >16kb
    auto_partial_merge: true

# JSON parsing and label extraction transform
transforms:
  parse_and_label:
    type: remap
    inputs:
      - docker_logs
    source: |
      # Parse JSON logs - if parsing fails, keep raw message
      parsed, err = parse_json(.message)

      if err == null {
        # Extract env and level from JSON for labels
        .labels.env = parsed.env
        .labels.level = parsed.level

        # Keep parsed JSON as the message (or extract specific field)
        .message = encode_json(parsed)
      } else {
        # JSON parsing failed - mark with label and keep raw message
        .labels.level = "unknown"
        .labels.env = "unknown"
      }

      # Extract container metadata as labels
      .labels.container_name = .container_name
      .labels.container_image = .image

      # Extract image tag from full image string (e.g., "nginx:1.21" -> "1.21")
      image_parts = split(.image, ":") ?? []
      .labels.image_tag = get(image_parts, [1]) ?? "latest"

      # Extract service name from image (e.g., "registry.com/ingestion:latest" -> "ingestion")
      # Split by "/" to remove registry, then split by ":" to remove tag
      image_without_tag = get(image_parts, [0]) ?? .image
      path_parts = split(image_without_tag, "/") ?? []
      .labels.service = get(path_parts, [-1]) ?? image_without_tag

      # Extract OCI image labels (from Docker metadata)
      # These come from LABEL directives in Dockerfile
      if exists(.label."org.opencontainers.image.version") {
        .labels.image_version = .label."org.opencontainers.image.version"
      }

      if exists(.label."org.opencontainers.image.revision") {
        .labels.image_revision = .label."org.opencontainers.image.revision"
      }

      if exists(.label."org.opencontainers.image.created") {
        .labels.image_created = .label."org.opencontainers.image.created"
      }

      # Keep traceId in message for correlation (don't promote to label - high cardinality)
      # Loki/Grafana will extract it for trace linking

# Loki sink
sinks:
  loki:
    type: loki
    inputs:
      - parse_and_label
    endpoint: http://loki:3100

    # Map labels to Loki labels
    labels:
      env: "{{ labels.env }}"
      level: "{{ labels.level }}"
      service: "{{ labels.service }}"

    # Encoding and compression
    encoding:
      codec: json

    compression: snappy

    # Handle out-of-order logs
    out_of_order_action: accept

    # Batching configuration
    batch:
      timeout_secs: 1
      max_events: 100000
      max_bytes: 1048576
