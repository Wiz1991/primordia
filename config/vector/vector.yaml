# Data directory for Vector state
data_dir: /var/lib/vector

# Docker logs source - only collect from containers with vector.logs.enable=true
sources:
  docker_logs:
    type: docker_logs
    docker_host: unix:///var/run/docker.sock

    # Only collect logs from containers with this label
    include_labels:
      - "vector.logs.enable=true"

    # Auto-merge split messages >16kb
    auto_partial_merge: true

# JSON parsing and label extraction transform
transforms:
  parse_and_label:
    type: remap
    inputs:
      - docker_logs
    source: |
      # Parse JSON logs and merge with container metadata
      parsed, err = parse_json(.message)

      if err == null {
        # Merge parsed JSON with container metadata at root
        . = merge(., parsed) ?? .
      }

      # Add container metadata fields to the JSON
      .container_name = .container_name
      .container_image = .image

      # Extract image tag from full image string (e.g., "nginx:1.21" -> "1.21")
      image_parts = split(.image, ":") ?? []
      .image_tag = get(image_parts, [1]) ?? "latest"

      # Extract service name from image (e.g., "registry.com/ingestion:latest" -> "ingestion")
      image_without_tag = get(image_parts, [0]) ?? .image
      path_parts = split(image_without_tag, "/") ?? []
      .service = get(path_parts, [-1]) ?? image_without_tag

      # Add OCI image labels to the JSON
      if exists(.label."org.opencontainers.image.version") {
        .image_version = .label."org.opencontainers.image.version"
      }

      if exists(.label."org.opencontainers.image.revision") {
        .image_revision = .label."org.opencontainers.image.revision"
      }

      if exists(.label."org.opencontainers.image.created") {
        .image_created = .label."org.opencontainers.image.created"
      }

      # Ensure defaults for label extraction
      .env = .env ?? "unknown"
      .level = .level ?? "unknown"

      # Re-encode as JSON for Loki
      .message = encode_json(.) ?? .message

# Loki sink
sinks:
  loki:
    type: loki
    inputs:
      - parse_and_label
    endpoint: http://loki:3100

    # Map labels to Loki labels
    labels:
      env: "{{ env }}"
      level: "{{ level }}"
      service: "{{ service }}"

    # Structured metadata (high cardinality container info)
    structured_metadata:
      image_version: "{{ image_version }}"
      image_revision: "{{ image_revision }}"
      image_created: "{{ image_created }}"
      container_name: "{{ container_name }}"
      container_image: "{{ image }}"
      image_tag: "{{ image_tag }}"

    # Encoding and compression
    encoding:
      codec: json

    compression: snappy

    # Handle out-of-order logs
    out_of_order_action: accept

    # Batching configuration
    batch:
      timeout_secs: 1
      max_events: 100000
      max_bytes: 1048576
