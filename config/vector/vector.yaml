# Data directory for Vector state
data_dir: /var/lib/vector

# Docker logs source - only collect from containers with vector.logs.enable=true
sources:
  docker_logs:
    type: docker_logs
    docker_host: unix:///var/run/docker.sock

    # Only collect logs from containers with this label
    include_labels:
      - "vector.logs.enable=true"

    # Auto-merge split messages >16kb
    auto_partial_merge: true

# JSON parsing and label extraction transform
transforms:
  parse_and_label:
    type: remap
    inputs:
      - docker_logs
    source: |
      # Save container metadata BEFORE parsing (so merge doesn't overwrite)
      container_name_original = .container_name
      image_original = .image

      # Parse JSON from the message field and merge to root
      parsed, err = parse_json(.message)

      if err == null && is_object(parsed) {
        # Merge parsed JSON object into root
        . = merge(., object!(parsed)) ?? .
      }

      # Restore and store container metadata (merge may have overwritten)
      .container_name_meta = container_name_original
      .container_image_meta = image_original

      # Extract image tag from full image string (e.g., "nginx:1.21" -> "1.21")
      image_parts = split(image_original, ":") ?? []
      .image_tag = get(image_parts, [1]) ?? "latest"

      # Extract service name from IMAGE (e.g., "registry.com/ingestion:latest" -> "ingestion")
      # DO THIS AFTER MERGE so it overwrites any service_name from the log
      image_without_tag = get(image_parts, [0]) ?? image_original
      path_parts = split(image_without_tag, "/") ?? []
      service_extracted = get(path_parts, [-1]) ?? image_without_tag

      # Debug: store intermediate values to verify extraction
      .debug_image_original = image_original
      .debug_image_without_tag = image_without_tag
      .debug_service_extracted = service_extracted

      # Force set service_name to extracted value (overwrite anything from merge)
      .service_name = service_extracted
      .service = service_extracted


      # Ensure defaults for label extraction
      .env = .env ?? "unknown"
      .level = .level ?? "unknown"

# Loki sink
sinks:
  loki:
    type: loki
    inputs:
      - parse_and_label
    endpoint: http://loki:3100

    # Map labels to Loki labels
    labels:
      env: "{{ env }}"
      level: "{{ level }}"
      service_name: "{{ service_name }}"

    # Encoding and compression
    encoding:
      codec: json

    compression: snappy

    # Handle out-of-order logs
    out_of_order_action: accept

    # Batching configuration
    batch:
      timeout_secs: 1
      max_events: 100000
      max_bytes: 1048576
