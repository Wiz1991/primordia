server:
  log_level: info

traces:
  configs:
    - name: glutton
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317
            http:
              endpoint: 0.0.0.0:4318

      remote_write:
        - endpoint: tempo:4317
          insecure: true

logs:
  configs:
    - name: glutton
      positions:
        filename: /tmp/positions.yaml

      scrape_configs:
        - job_name: docker
          docker_sd_configs:
            - host: unix:///var/run/docker.sock
              refresh_interval: 5s
              filters:
                - name: label
                  values: [ "service.name" ]

          relabel_configs:
            - source_labels: [ __meta_docker_container_label_service_name ]
              regex: .+
              target_label: service

          pipeline_stages:
            # Parse JSON logs - extract ALL fields
            - json:
                expressions:
                  timestamp: timestamp
                  level: level
                  service: service
                  env: env

            # Use timestamp from log if available
            - timestamp:
                source: timestamp
                format: RFC3339

            # Promote LOW CARDINALITY fields to labels (for fast filtering)
            - labels:
                level:
                service:
                env:

            # DO NOT use output stage - keep the raw JSON log line
            # This way Grafana's "Detected fields" will show ALL your JSON fields
            # You can click on any log to see all fields expanded
            # To filter by a field, use: {service="ingestion"} | json | jobId="123"

      clients:
        - url: http://loki:3100/loki/api/v1/push
