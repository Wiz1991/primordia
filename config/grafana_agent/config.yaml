server:
  log_level: info

traces:
  configs:
    - name: glutton
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317
            http:
              endpoint: 0.0.0.0:4318

      remote_write:
        - endpoint: tempo:4317
          insecure: true

logs:
  configs:
    - name: glutton
      positions:
        filename: /tmp/positions.yaml

      scrape_configs:
        - job_name: docker
          docker_sd_configs:
            - host: unix:///var/run/docker.sock
              refresh_interval: 5s
              filters:
                - name: label
                  values: [ "service.name" ]

      relabel_configs:
        - source_labels: [ __meta_docker_container_label_service_name ]
          regex: .+
          target_label: service

          pipeline_stages:
            # Parse JSON logs
            - json:
                expressions:
                  timestamp: timestamp
                  level: level
                  message: message
                  env: env
                  service: service
                  queue: queue
                  jobId: jobId
                  traceId: traceId
                  spanId: spanId
                  host: host
                  pid: pid

            # Use timestamp from log if available
            - timestamp:
                source: timestamp
                format: RFC3339

            # Promote to labels (low cardinality only)
            - labels:
                level:
                service:
                queue:
                env:

            # Set message as the log line
            - output:
                source: message

      clients:
        - url: http://loki:3100/loki/api/v1/push
